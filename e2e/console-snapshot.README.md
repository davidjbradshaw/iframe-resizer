# Console Validation Test

## Overview

This test validates console behavior during a comprehensive user interaction workflow. It runs against both **dev** and **prod** builds (both using js/ directory) to ensure error-free operation.

## Purpose

- **Error Detection**: Catch console errors during complex interaction sequences
- **Event Validation**: Verify key events fire correctly (resize, scroll, messages)
- **Build Validation**: Ensure both dev and prod builds work without errors
- **Regression Prevention**: Detect when changes break core functionality

## How It Works

### 1. Build Testing

The test runs against the js/ directory, with different builds tested separately:

- **Dev Build** (`console-dev` project):
  - Built with `DEBUG=1`
  - Includes full debug logging and test code
  - Generated by `npm run build:dev`
  - Run test: `npx playwright test console-snapshot --project=console-dev`

- **Prod Build** (`console-prod` project):
  - Production optimized
  - Debug code stripped out
  - Generated by `npm run vite:prod`
  - Run test: `npx playwright test console-snapshot --project=console-prod`

**Important**: Each test expects the appropriate build to be in js/ before running. Builds are run separately to prevent overwriting each other.

### 2. Console Validation

The test monitors console output and validates:
- **No errors occur** (excluding expected 404s)
- **Resize events fire** (dev build only - stripped in prod)
- **Message events fire** (dev build only - stripped in prod)
- **Scroll events fire** when triggered
- **Minimum log count** ensures logging hasn't been accidentally disabled

Validation is build-aware:
- **Dev build**: Expects detailed debug logging (100+ logs, resize/message events)
- **Prod build**: Minimal logging acceptable (10+ logs, events may be stripped)

### 3. User Interaction Workflow

The test executes this sequence on `/example-test/html/index.html`:

1. Open modal → Close modal
2. Toggle content
3. Mutate text node
4. Insert overflow
5. autoResize(false)
6. Remove overflow
7. autoResize(true)
8. Insert content
9. Absolute Position
10. Jump to iFrame anchor
11. Scroll to top
12. Scroll to iFrame
13. scrollBy(50)
14. Jump to parent anchor → Back to page 1
15. Navigate to Overflow page
16. Toggle ignore (×2)
17. Back to page 1
18. Nested navigation (×4)
19. Send Message (with alert dialogs)
20. Toggle content again
21. Navigate to two iframes page
22. Nested in frame 1
23. Toggle content in frame 2
24. Back to single iframe
25. Navigate to TextArea
26. Resize textarea
27. Back to page 1
28. Navigate to 404 page

### 4. Test Assertions

The test makes several assertions:

**All builds:**
- No console errors (filtered to exclude expected 404s from testing)

**Dev build only:**
- Resize events > 0 (proves iframe resizing works)
- Message events > 0 (proves parent-child communication)
- Total logs > 100 (proves debug logging enabled)

**Prod build:**
- Total logs > 10 (minimal logging threshold)

## Running the Tests

**Important:** Build and test each version separately to prevent builds from overwriting each other.

### Run Console Snapshot Tests

```bash
# Test dev build
npm run build:dev
npm run test:e2e:console:dev

# Test prod build
npm run vite:prod
npm run test:e2e:console:prod
```

Or using Playwright directly:

```bash
# Dev build
npm run build:dev
npx playwright test console-snapshot --project=console-dev

# Prod build
npm run vite:prod
npx playwright test console-snapshot --project=console-prod
```

### Updating Test Expectations

If you need to update event count expectations or add new validations, edit the assertions in `e2e/console-snapshot.spec.js`.

### View Test Results

```bash
# Open HTML report
npx playwright show-report
```

## When Tests Fail

### Console Errors

If errors are detected:
1. Check the test output for the specific error message
2. Verify the error isn't from expected scenarios (404 tests)
3. Run with `--headed --debug` to see the error in browser console
4. Fix the underlying issue causing the error

### Missing Events

If resize/message event counts are 0 (dev build):
1. Verify the page loaded correctly
2. Check that user interactions are completing
3. Ensure debug logging isn't disabled
4. Review test output for warnings

### Debugging Failures

1. **Run with headed browser**:
   ```bash
   npx playwright test console-snapshot --project=console-dev --headed --debug
   ```

2. **Check test report**:
   ```bash
   npx playwright show-report
   ```

3. **Verify build**:
   ```bash
   # Ensure correct build is in js/
   ls -lh js/
   ```

## Maintenance

### Adding New Interaction Steps

1. Add new test step in `console-snapshot.spec.js`
2. Run test with `--update-snapshots` to capture new output
3. Review the snapshot diff to ensure only expected logs were added
4. Commit the updated snapshots

### Modifying Existing Steps

1. Update the step logic
2. Run test to see if snapshots still match
3. If intentional change, update snapshots
4. Review diff to ensure no unintended side effects

### Normalizing New Dynamic Content

If new logs contain dynamic content (timestamps, IDs, etc.), update the `normalizeLog()` function:

```javascript
function normalizeLog(log) {
  return log
    .replace(/@0x[\da-f]+/gi, '@0xXXXXXX')  // Existing
    .replace(/\d+ms/g, 'XXXms')              // Existing
    // Add new patterns here:
    .replace(/session-[\w-]+/g, 'session-XXX')
}
```

## Integration with CI

These tests run as part of the standard e2e test suite:

```bash
npm run test:e2e  # Includes console snapshot tests
```

On CI, snapshot failures will fail the build, preventing unintended logging changes from being merged.

## Troubleshooting

### Flaky Snapshots

If snapshots are flaky:
- Increase `waitForTimeout` values for slow operations
- Add more specific `waitFor` conditions before capturing logs
- Check for race conditions in the interaction steps

### Missing Logs

If expected logs aren't captured:
- Verify the page loads iframe-resizer correctly
- Check browser console for errors
- Ensure `log: true` is set in the test HTML
- Verify the log filter in `page.on('console')` is correct

### Wrong Build Being Tested

If the wrong build is being tested:
- Verify you ran the correct build command before testing (`npm run build:dev` for dev tests, `npm run vite:prod` for prod tests)
- Check that js/ directory contains the expected build (check file size: dev ~87KB with source maps, prod ~35KB without)
- Clear js/ and rebuild if uncertain which build is present
- Use DevTools Network tab to verify which scripts load
