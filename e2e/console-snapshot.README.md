# Console Snapshot Test

## Overview

This test captures and validates console log output from iframe-resizer during a comprehensive user interaction workflow. It runs against both **dev** and **prod** builds (both using js/ directory) to ensure consistent logging behavior.

## Purpose

- **Regression Detection**: Catch unintended changes in logging output
- **Build Comparison**: Verify both dev and prod builds behave consistently
- **Documentation**: Serve as a living document of expected console behavior
- **Debugging**: When logs change unexpectedly, the diff shows exactly what changed

## How It Works

### 1. Build Testing

The test runs against the js/ directory, with different builds tested separately:

- **Dev Build** (`console-dev` project):
  - Built with `DEBUG=1`
  - Includes full debug logging and test code
  - Generated by `npm run build:dev`
  - Run test: `npx playwright test console-snapshot --project=console-dev`

- **Prod Build** (`console-prod` project):
  - Production optimized
  - Debug code stripped out
  - Generated by `npm run vite:prod`
  - Run test: `npx playwright test console-snapshot --project=console-prod`

**Important**: Each test expects the appropriate build to be in js/ before running. Builds are run separately to prevent overwriting each other.

### 2. Console Capture

The test captures all console output emitted during the workflow (no filtering is applied). This includes:
- iframe-resizer framework logs (prefixed with `[iframe-resizer`)
- Application-specific logs from the test pages
- Any errors or warnings emitted during test execution

Logs are normalized to remove:
- Memory addresses (`@0x123456` → `@0xXXXXXX`)
- Timestamps (`123ms` → `XXXms`)
- File paths (normalized to `file:///PATH`)
- Line/column numbers (`:123:45` → `:XX:XX`)

### 3. User Interaction Workflow

The test executes this sequence on `/example-test/html/index.html`:

1. Open modal → Close modal
2. Toggle content
3. Mutate text node
4. Insert overflow
5. autoResize(false)
6. Remove overflow
7. autoResize(true)
8. Insert content
9. Absolute Position
10. Jump to iFrame anchor
11. Scroll to top
12. Scroll to iFrame
13. scrollBy(50)
14. Jump to parent anchor → Back to page 1
15. Navigate to Overflow page
16. Toggle ignore (×2)
17. Back to page 1
18. Nested navigation (×4)
19. Send Message (with alert dialogs)
20. Toggle content again
21. Navigate to two iframes page
22. Nested in frame 1
23. Toggle content in frame 2
24. Back to single iframe
25. Navigate to TextArea
26. Resize textarea
27. Back to page 1
28. Navigate to 404 page

### 4. Snapshot Comparison

Captured logs are saved to:
- `e2e/console-snapshot.spec.js-snapshots/console-logs-console-dev.txt`
- `e2e/console-snapshot.spec.js-snapshots/console-logs-console-prod.txt`

Note: Playwright stores text snapshots in a directory named after the test file and automatically appends the project name to the snapshot filename. The snapshots are platform-agnostic and will work across different operating systems.

On subsequent runs, Playwright compares new output against these snapshots.

## Running the Tests

**Important:** Build and test each version separately to prevent builds from overwriting each other.

### Run Console Snapshot Tests

```bash
# Test dev build
npm run build:dev
npm run test:e2e:console:dev

# Test prod build
npm run vite:prod
npm run test:e2e:console:prod
```

Or using Playwright directly:

```bash
# Dev build
npm run build:dev
npx playwright test console-snapshot --project=console-dev

# Prod build
npm run vite:prod
npx playwright test console-snapshot --project=console-prod
```

### Update Snapshots

When logging behavior intentionally changes:

```bash
# Update dev snapshot
npm run build:dev
npm run test:e2e:console:update:dev

# Update prod snapshot
npm run vite:prod
npm run test:e2e:console:update:prod

# Commit updated snapshots
git add e2e/*-snapshots/
git commit -m "Update console snapshots"
```

### View Test Results

```bash
# Open HTML report
npx playwright show-report
```

## When Snapshots Fail

### Expected Failures

Snapshots should be updated when:
- ✅ New features add logging
- ✅ Log messages are improved
- ✅ Log formatting changes intentionally
- ✅ Debug code behavior changes

### Unexpected Failures

Investigate when:
- ❌ Prod and dev outputs diverge unexpectedly
- ❌ Logs disappear without code changes
- ❌ Error messages appear in output
- ❌ Performance characteristics change (many more/fewer logs)

### Debugging Failures

1. **View the diff**:
   ```bash
   # Playwright shows exact diff in the test report
   npx playwright show-report
   ```

2. **Compare builds manually**:
   ```bash
   # Check if build artifacts changed
   git diff e2e/*-snapshots/
   ```

3. **Run interactively**:
   ```bash
   # See logs in real-time with headed browser
   npx playwright test console-snapshot --project=console-dev --headed --debug
   ```

4. **Inspect actual vs expected**:
   - Failed snapshots are saved to `test-results/`
   - Compare `-actual.txt` vs `-expected.txt`

## Maintenance

### Adding New Interaction Steps

1. Add new test step in `console-snapshot.spec.js`
2. Run test with `--update-snapshots` to capture new output
3. Review the snapshot diff to ensure only expected logs were added
4. Commit the updated snapshots

### Modifying Existing Steps

1. Update the step logic
2. Run test to see if snapshots still match
3. If intentional change, update snapshots
4. Review diff to ensure no unintended side effects

### Normalizing New Dynamic Content

If new logs contain dynamic content (timestamps, IDs, etc.), update the `normalizeLog()` function:

```javascript
function normalizeLog(log) {
  return log
    .replace(/@0x[\da-f]+/gi, '@0xXXXXXX')  // Existing
    .replace(/\d+ms/g, 'XXXms')              // Existing
    // Add new patterns here:
    .replace(/session-[\w-]+/g, 'session-XXX')
}
```

## Integration with CI

These tests run as part of the standard e2e test suite:

```bash
npm run test:e2e  # Includes console snapshot tests
```

On CI, snapshot failures will fail the build, preventing unintended logging changes from being merged.

## Troubleshooting

### Flaky Snapshots

If snapshots are flaky:
- Increase `waitForTimeout` values for slow operations
- Add more specific `waitFor` conditions before capturing logs
- Check for race conditions in the interaction steps

### Missing Logs

If expected logs aren't captured:
- Verify the page loads iframe-resizer correctly
- Check browser console for errors
- Ensure `log: true` is set in the test HTML
- Verify the log filter in `page.on('console')` is correct

### Wrong Build Being Tested

If the wrong build is being tested:
- Verify you ran the correct build command before testing (`npm run build:dev` for dev tests, `npm run vite:prod` for prod tests)
- Check that js/ directory contains the expected build (check file size: dev ~87KB with source maps, prod ~35KB without)
- Clear js/ and rebuild if uncertain which build is present
- Use DevTools Network tab to verify which scripts load
