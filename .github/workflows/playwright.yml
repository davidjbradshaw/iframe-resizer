# This workflow runs Playwright e2e tests including console snapshot tests
# For more information see: https://playwright.dev/docs/ci

name: Playwright

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [ "master", "dev" ]
  pull_request:
    branches: [ "master", "dev" ]

jobs:
  e2e-tests:
    timeout-minutes: 60
    name: E2E tests (chromium)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Build project
      run: npm run vite:prod

    - name: Build React example for e2e tests
      run: |
        cd example/react
        npm install
        npm run build

    - name: Build Vue example for e2e tests
      run: |
        cd example/vue
        npm install
        npm run build

    - name: Run Playwright tests
      run: npm run test:e2e

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30

    - name: Upload test screenshots
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-screenshots
        path: test-results/
        retention-days: 30

  console-snapshot-dev:
    timeout-minutes: 20
    name: Console snapshot - dev build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Build dev version (DEBUG=1)
      run: npm run build:dev

    - name: Run console snapshot test - dev build
      run: npx playwright test console-snapshot --project=console-dev

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: console-snapshot-dev-report
        path: playwright-report/
        retention-days: 30

    - name: Upload snapshot diffs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: console-snapshot-dev-diffs
        path: test-results/
        retention-days: 30

  console-snapshot-prod:
    timeout-minutes: 20
    name: Console snapshot - prod build
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [22.x]

    steps:
    - uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium

    - name: Build prod version (optimized)
      run: npm run vite:prod

    - name: Run console snapshot test - prod build
      run: npx playwright test console-snapshot --project=console-prod

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: console-snapshot-prod-report
        path: playwright-report/
        retention-days: 30

    - name: Upload snapshot diffs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: console-snapshot-prod-diffs
        path: test-results/
        retention-days: 30

  # Comment on PR if either snapshot test fails
  comment-on-snapshot-failure:
    name: Comment on PR with snapshot failure info
    runs-on: ubuntu-latest
    needs: [console-snapshot-dev, console-snapshot-prod]
    if: always() && (needs.console-snapshot-dev.result == 'failure' || needs.console-snapshot-prod.result == 'failure') && github.event_name == 'pull_request'

    steps:
    - name: Comment on PR with snapshot diff
      uses: actions/github-script@v7
      with:
        script: |
          let comment = '## ‚ö†Ô∏è Console Snapshot Test Failed\n\n';
          comment += 'The console log output has changed. This could indicate:\n';
          comment += '- Intentional logging improvements (update snapshots)\n';
          comment += '- Unintended behavioral changes (investigate)\n';
          comment += '- Build differences between dev and prod (investigate)\n\n';
          comment += '### Failed Jobs\n\n';
          comment += 'Check the workflow run for details on which build(s) failed:\n';
          comment += '- Dev build snapshot test\n';
          comment += '- Prod build snapshot test\n\n';
          comment += '### Next Steps\n\n';
          comment += '**If this change is intentional:**\n';
          comment += '```bash\n';
          comment += '# Update dev build snapshots\n';
          comment += 'npm run build:dev\n';
          comment += 'npx playwright test console-snapshot --project=console-dev --update-snapshots\n';
          comment += '\n';
          comment += '# Update prod build snapshots\n';
          comment += 'npm run vite:prod\n';
          comment += 'npx playwright test console-snapshot --project=console-prod --update-snapshots\n';
          comment += '\n';
          comment += 'git add e2e/*-snapshots/\n';
          comment += 'git commit -m "Update console snapshots"\n';
          comment += '```\n\n';
          comment += '**If this change is unintended:**\n';
          comment += 'Review the test results artifacts to see what changed in the console output.\n\n';
          comment += 'üìä [View detailed test report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n';

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
